# 23. Соглашения о вызовах. Понятие, основные виды соглашений.

---

## Соглашения о вызовах

Описания технических особенностей вызова подпрограмм, определяющие:

- способы передачи параметров подпрограммам;
- способы передачи управления подпрограмм;
- способы передачи результатов выполнения из подпрограмм в точку вызова;
- способы передачи управления из подпрограмм в точку вызова.

## Основные виды соглашений

- cdecl
- pascal
- stdcall (WinAPI)
- fastcall
- safecall
- thiscall



### cdecl

---

`cdecl` — соглашение о вызовах, используемое [компиляторами](https://ru.wikipedia.org/wiki/Компилятор) для [языка](https://ru.wikipedia.org/wiki/Язык_программирования) [Си](https://ru.wikipedia.org/wiki/Си_(язык_программирования)) (отсюда название).

Аргументы [функций](https://ru.wikipedia.org/wiki/Функция_(программирование)) передаются через стек, справа налево. Аргументы, размер которых меньше 4 байт, расширяются до 4 байт. Очистку стека производит [**вызывающая** программа](https://ru.wikipedia.org/wiki/Соглашение_о_вызове#вызывающая_функция). Это основной способ вызова [функций](https://ru.wikipedia.org/wiki/Функция_(программирование)) с переменным числом аргументов (например, `printf()`). Способы получения возвращаемого значения функции приведены в таблице.

|       [Тип](https://ru.wikipedia.org/wiki/Тип_данных)        | Размер возвращаемого значения, [байт](https://ru.wikipedia.org/wiki/Байт) |            Способ передачи возвращаемого значения            |                          Примечание                          |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| Целое число, [указатель](https://ru.wikipedia.org/wiki/Указатель_(тип_данных)) |                           1, 2, 4                            | Через [регистр](https://ru.wikipedia.org/wiki/Регистр_процессора) `eax` | Значения, размер которых меньше 4 байт, расширяются до 4 байт |
|                         Целое число                          |                              8                               | Через пару [регистров](https://ru.wikipedia.org/wiki/Регистр_процессора) `edx:eax` |                                                              |
| [Число с плавающей точкой](https://ru.wikipedia.org/wiki/Число_с_плавающей_запятой) |                             4, 8                             | Через [регистр](https://ru.wikipedia.org/wiki/Регистр_процессора) `st0` (из псевдостека [x87](https://ru.wikipedia.org/wiki/X87), [FPU](https://ru.wikipedia.org/wiki/FPU)) |                                                              |
|                            Другие                            |                           Больше 8                           | Через [регистр](https://ru.wikipedia.org/wiki/Регистр_процессора) `eax` | [Указатель](https://ru.wikipedia.org/wiki/Указатель_(тип_данных)) на [структуру данных](https://ru.wikipedia.org/wiki/Структура_данных) сохраняется в [регистре](https://ru.wikipedia.org/wiki/Регистр_процессора) `eax` |

Перед вызовом [функции](https://ru.wikipedia.org/wiki/Функция_(программирование)) вставляется [код](https://ru.wikipedia.org/wiki/Машинный_код), называемый **прологом** ([англ.](https://ru.wikipedia.org/wiki/Английский_язык) *prolog*) и выполняющий следующие действия:

- сохранение значений [регистров](https://ru.wikipedia.org/wiki/Регистр_процессора), используемых внутри [функции](https://ru.wikipedia.org/wiki/Функция_(программирование));
- запись в стек аргументов [функции](https://ru.wikipedia.org/wiki/Функция_(программирование)).

После вызова [функции](https://ru.wikipedia.org/wiki/Функция_(программирование)) вставляется [код](https://ru.wikipedia.org/wiki/Машинный_код), называемый **эпилогом** ([англ.](https://ru.wikipedia.org/wiki/Английский_язык) *epilog*) и выполняющий следующие действия:

- восстановление значений [регистров](https://ru.wikipedia.org/wiki/Регистр_процессора), сохранённых кодом пролога;
- очистка стека (от [локальных переменных](https://ru.wikipedia.org/wiki/Локальная_переменная) [функции](https://ru.wikipedia.org/wiki/Функция_(программирование))).